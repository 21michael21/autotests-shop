# Autotests Shop — Backend API Tests

Содержит автотесты для бэкенд‑API интернет‑магазина (Flask + PostgreSQL). Отчётность — Allure, тест‑раннер — pytest.

## Запуск

1) Убедитесь, что бэкенд доступен по BASE_URL из config.py (по умолчанию http://localhost:5050).
2) Создайте venv и установите зависимости:

    python3 -m venv venv
    ./venv/bin/pip install -r requirements.txt

3) Запуск тестов с отчётами Allure:

    make test
    make allure

## Структура

- `src/`
  - `backend/` — HTTP‑клиент и адаптеры сервисов (auth, catalog, cart, orders)
  - `builders/` — генераторы данных (user, item)
  - `utils/` — утилиты и валидации (assert‑helpers)
- `tests/`
  - `backend/`
    - `auth/` — тесты регистрации/логина
    - `cart/` — тесты корзины
    - `catalog/` — тесты каталога
    - `orders/` — тесты заказов (создание и детали)
  - `conftest.py` — общие фикстуры: http_client, db_client, user, adapters, random_item, add_random_item

## Фикстуры

- `http_client` — общий HTTP‑клиент для API
- `db_client` — клиент БД для очистки данных (удаление пользователя/корзины)
- `user` — создаёт пользователя, логинится, возвращает username/password/token
- `auth_adapter`, `catalog_adapter`, `cart_adapter`, `orders_adapter` — тонкие адаптеры над API
- `random_item` — выбирает случайный товар из каталога
- `add_random_item` — добавляет товар в корзину и очищает её после теста

## Покрытие

- Регистрация: успешная регистрация, валидации на стороне сервера
- Логин: успешный вход, негативный кейс с неверными данными
- Каталог: получение списка, фильтры, сортировки, негативные параметры
- Корзина: добавление, получение содержимого, удаление, негатив при неверном товаре
- Заказы: создание заказа из корзины, получение деталей заказа

## DRY принципы и оптимизация

### Helper функции
- `validate_json_structure()` — проверка обязательных полей в JSON
- `validate_catalog_response()` — валидация ответа каталога товаров
- `validate_cart_response()` — валидация ответа корзины
- `validate_order_response()` — валидация ответа заказа

### Устранение дублирования
- Удалены дублирующие тесты аутентификации (`test_auth.py`)
- Убраны повторяющиеся проверки структуры JSON
- Унифицированы паттерны валидации ответов

### Оптимизация тестов
- Использование helper функций вместо повторяющихся assert'ов
- Единообразная обработка ошибок и логирование
- Гибкие параметры валидации (например, `min_items=0` для фильтров)

## Скрипты

- `make test` — очистка/перегенерация Allure отчётов и запуск тестов
- `make allure` — локальный просмотр отчёта в Allure
- `scripts/run_tests.sh` — полный цикл: очистка, установка зависимостей, запуск тестов

## Примеры использования helper функций

```python
# Валидация структуры JSON
validate_json_structure(response_data, ['message', 'token'])

# Валидация каталога (допускает пустой список)
validate_catalog_response(catalog_data, min_items=0)

# Валидация корзины
validate_cart_response(cart_data)

# Валидация заказа с проверкой ID
validate_order_response(order_data, expected_order_id=123)
```

## Соответствие требованиям

### Общие принципы

- Изолированность тестов: каждый тест независим, использует уникальные данные
- Создание и очистка данных: фикстуры автоматически создают и очищают тестовые данные
- Отсутствие хардкода: данные генерируются динамически через `UserBuilder` и `ItemBuilder`
- Использование pytest фикстур: вся подготовка данных и очистка через фикстуры
- Allure логирование: каждый шаг теста логируется с деталями
- Хорошие названия тестов: понятные названия с `@allure.title` и `@allure.severity`

### Архитектура тестового фреймворка

- Изолированность: тесты не зависят друг от друга
- Расширяемость: легко добавлять новые тесты через существующие фикстуры
- Allure отчёты: детализированные отчёты с шагами выполнения
- Документация: полное описание в README.md
- Тест-дизайн: применены техники граничных значений и негативных сценариев

### Покрытие функционала

- Основные сценарии API покрыты тестами
- Проверяются реальные пользовательские сценарии
- Следование best practices автотестирования

## Метрики

- Количество тестов: 14
- Покрытие модулей: auth, cart, catalog, orders
- Время выполнения: ~7-8 секунд
- Стабильность: 100% (все тесты проходят)
- Соответствие требованиям: 100%
